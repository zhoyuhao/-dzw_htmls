<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>站外接单</title>
		<link rel="stylesheet" type="text/css" href="../css/index.css" />
		<script type="text/javascript" src="../js/vue.js"></script>
		<script type="text/javascript" src="../js/jquery-1.12.4.js"></script>
		<script type="text/javascript" src="../js/jq_ajax_config.js"></script>
		<style type="text/css">
			* {
				text-align: center;
			}
			
			.winput {
				width: 120px;
			}
		</style>
	</head>

	<body>
		<div id="zhanwai">
			<el-container>
				<el-main>
					<el-tabs value="first" style="margin: 0px auto;margin-top: 20px;width: 90%;">
						<el-tab-pane label="作业中车辆" name="first">
							<el-form :model="form" label-width="100px" size="mini" label-position="left" :inline="true">
								<el-form-item label="车牌号码：">
									<el-input v-model="form.wcarid" size="mini" clearable></el-input>
								</el-form-item>
								<el-form-item>
									<el-form-item>
										<el-button @click="getServiceData(1)" type="primary" size="mini">查询信息</el-button>
										<el-button @click="openServiceDialog" type="primary" size="mini">维修接车</el-button>
									</el-form-item>
							</el-form>
							<el-table :data="fixdata.list" size="small">
								<el-table-column label="维修单号" prop="wid" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="接车人" prop="wjname" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="顾客姓名" prop="wname" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="车牌号码" prop="wcarid" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="手机号码" prop="wphone" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="会员卡号" prop="wvipid" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="维修状态" prop="wstatic" align="center" show-overflow-tooltip>
									<template slot-scope="temp">
										{{temp.row.wstatic == 1 ?'接车':'接车'}}
									</template>
								</el-table-column>
								<el-table-column label="调度派工" align="center" show-overflow-tooltip>
									<template slot-scope="temp">
										<el-button @click="centerDialogVisible2 = true" circle size="small" icon="el-icon-thumb"></el-button>
									</template>
								</el-table-column>
							</el-table>
							<div style="margin: 20px 0px;">
								<el-button @click="getServiceData(1)" type="primary" size="mini">首页</el-button>
								<el-button @click="getServiceData(fixdata.prePage)" v-if="fixdata.hasPreviousPage" type="primary" size="mini">上一页</el-button>
								<el-button @click="getServiceData(fixdata.nextPage)" v-if="fixdata.hasNextPage" type="primary" size="mini">下一页</el-button>
								<el-button @click="getServiceData(fixdata.navigateLastPage)" type="primary" size="mini">尾页</el-button>
							</div>
							<!--<el-divider content-position="center">客户及车辆信息</el-divider>
							<el-table :data="userdata" size="small">
								<el-table-column label="客户信息">
									<el-table-column label="用户姓名" prop="name" align="center" show-overflow-tooltip>
									</el-table-column>
									<el-table-column label="用户类型" prop="type" align="center" show-overflow-tooltip>
									</el-table-column>
									<el-table-column label="用户生日" prop="birthday" align="center" show-overflow-tooltip>
									</el-table-column>
									<el-table-column label="手机号码" prop="phone" align="center" show-overflow-tooltip>
									</el-table-column>
									<el-table-column label="用户地址" prop="address" align="center" show-overflow-tooltip>
									</el-table-column>
								</el-table-column>
							</el-table>
							<el-table :data="cardata" size="small">
								<el-table-column label="车辆信息">
									<el-table-column label="车辆品牌" prop="brand" align="center" show-overflow-tooltip>
									</el-table-column>
									<el-table-column label="车辆颜色" prop="color" align="center" show-overflow-tooltip>
									</el-table-column>
									<el-table-column label="车险日期" prop="dated" align="center" show-overflow-tooltip>
									</el-table-column>
									<el-table-column label="车类型" prop="cartype" align="center" show-overflow-tooltip>
									</el-table-column>
									<el-table-column label="发动机" prop="engine" align="center" show-overflow-tooltip>
									</el-table-column>
									<el-table-column label="保养日期" prop="mdate" align="center" show-overflow-tooltip>
									</el-table-column>
								</el-table-column>
							</el-table>-->
						</el-tab-pane>
						<el-tab-pane label="维修历史" name="second">
							<el-table :data="fixhistory" size="small" height="250">
								<el-table-column label="维修单号" prop="wid" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="接车时间" prop="wstatdate" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="业务类型" prop="tos" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="顾客姓名" prop="wname" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="车牌号码" prop="carid" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="手机号码" prop="phone" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="会员卡号" prop="usercard" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="结算时间" prop="rtime" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="消费金额" prop="price" align="center" show-overflow-tooltip>
								</el-table-column>
							</el-table>
						</el-tab-pane>
					</el-tabs>
					<el-dialog title="新增维修单" width="70%" :visible.sync="centerDialogVisible" center :close-on-click-modal="false" :close-on-press-escape="false" :modal="false" :show-close="false">
						<div>
							<el-form label-width="100px" :inline="true" size="mini" style="width: 100%;">
								<el-form-item label="维修单号：">
									<el-input v-model="formfix.wid" disabled></el-input>
								</el-form-item>
								<el-form-item label="客户姓名：">
									<el-input v-model="formfix.wname" ></el-input>
								</el-form-item>
								<el-form-item label="接车人：">
									<el-input v-model="formfix.wjname" ></el-input>
								</el-form-item>
								<el-form-item label="会员卡号：">
									<el-input v-model="formfix.wvipid" ></el-input>
								</el-form-item>
								<el-form-item label="开始时间：">
									<el-date-picker v-model="formfix.wstatdate" type="date" placeholder="选择日期" value-format="yyyy-MM-dd" style="width: 178px;">
									</el-date-picker>
								</el-form-item>
								<el-form-item label="结束时间：">
									<el-date-picker v-model="formfix.wenddate" type="date" placeholder="选择日期" value-format="yyyy-MM-dd" style="width: 178px;">
									</el-date-picker>
								</el-form-item>
								<el-form-item label="维修类型：">
									<el-select @change="getServiceGoodsData" v-model="formfix.tos" placeholder="请选择" size="mini" style="width: 178px;">
										<el-option v-for="item in fixgoodsitem" :key="item.xmid" :label="item.xnames" :value="item.xmid">
										</el-option>
									</el-select>
								</el-form-item>
								<el-form-item label="维修项目：">
									<el-select filterable v-model="formfix.fixitem" placeholder="请选择" size="mini" style="width: 178px;">
										<el-option v-for="item in fixgoods" :key="item.gid" :label="item.gname" :value="item.gid">
										</el-option>
									</el-select>
								</el-form-item>
								<el-form-item label="材料数量：">
									<el-input v-model.nunmber="formfix.fixcount" style="width: 120px;" size="mini"></el-input>
									<el-button @click="addServiceGoods" type="primary">添加</el-button>
								</el-form-item>
							</el-form>
							<el-table :data="fixitemdata" size="mini" height="200">
								<el-table-column label="维修项目" prop="sdname" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="项目价格" prop="sdprice" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="次数/数量" prop="sdnumber" align="center" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="操作" align="center" show-overflow-tooltip>
									<template slot-scope="temp">
										<el-button @click="removeServiceGoods(temp.$index)" circle size="small" icon="el-icon-close"></el-button>
									</template>
								</el-table-column>
							</el-table>
						</div>
						<span slot="footer" class="dialog-footer">
							<el-button @click="centerDialogVisible = false" size="small">取 消</el-button>
						  	<el-button type="primary" @click="addService" size="small">确 定</el-button>
						</span>
					</el-dialog>
					<el-dialog title="调度派工" :visible.sync="centerDialogVisible2" center :close-on-click-modal="false" :close-on-press-escape="false" :modal="false" :show-close="false">
						<div>
							<el-form label-width="100px" size="small" label-position="top">
								<el-form-item label="维修技工：">
									<el-select filterable v-model="formfix.fixgrop" placeholder="请选择" size="mini" style="width: 178px;">
										<!--<el-option-group v-for="item in opfixgrop" :key="item.value" :label="item.label" :value="item.value">
											<el-option v-for="obj in item.options" :key="obj.value" :label="obj.label" :value="obj.value">
											</el-option>
										</el-option-group>-->
									</el-select>
								</el-form-item>
								<el-form-item label="作业时间：">
									<el-date-picker v-model="fixgroptime" type="date" placeholder="选择日期" size="mini">
									</el-date-picker>
								</el-form-item>
							</el-form>
						</div>
						<span slot="footer" class="dialog-footer">
							<el-button @click="centerDialogVisible2 = false" size="small">取 消</el-button>
						  	<el-button type="primary" @click="centerDialogVisible2 = false" size="small">确 定</el-button>
						</span>
					</el-dialog>
					<el-dialog width="70%" title="客户及车辆信息添加" :visible.sync="UserAndCardDialog" center :close-on-click-modal="false" :close-on-press-escape="false" :show-close="false">
						<el-form label-width="100px" size="small" :inline="true">
							<el-form-item label="客户编号：">
								<el-input v-model="usersData.cidk" disabled></el-input>
								</el-date-picker>
							</el-form-item>
							<el-form-item label="客户姓名：">
								<el-input v-model="usersData.wnamek"></el-input>
							</el-form-item>
							<el-form-item label="客户地址：">
								<el-input v-model="usersData.caddressk"></el-input>
							</el-form-item>
							<el-form-item label="客户性别：">
								<div style="width: 200px;">
									<el-radio v-model="usersData.csexk" label="男">男</el-radio>
									<el-radio v-model="usersData.csexk" label="女">女</el-radio>
								</div>
							</el-form-item>
							<el-form-item label="客户号码：">
								<el-input v-model="usersData.cphonek"></el-input>
							</el-form-item>
							<el-form-item label="客户身份证：">
								<el-input v-model="usersData.cidnumberk"></el-input>
							</el-form-item>
							<el-form-item label="客户类型：">
								<el-select filterable v-model="usersData.ctypek" placeholder="请选择" size="mini" style="width: 200px;">
									<el-option key="临时客" label="临时客" value="临时客">
									</el-option>
									<el-option key="普通客户" label="普通客户" value="普通客户">
									</el-option>
									<el-option key="会员客户" label="会员客户" value="会员客户">
									</el-option>
								</el-select>
							</el-form-item>
							<el-form-item label="会员卡号：">
								<el-input v-model="usersData.ckahaok"></el-input>
							</el-form-item>
						</el-form>
						<span slot="footer" class="dialog-footer">
							<el-button @click="UserAndCardDialog = false" size="medium">取 消</el-button>
						  	<el-button type="primary" @click="UserAndCardDialog = false" size="medium">保 存</el-button>
						</span>
					</el-dialog>
				</el-main>
			</el-container>
		</div>
	</body>
	<script type="text/javascript" src="../js/index.js"></script>
	<script type="text/javascript">
		var zhanwai = new Vue({
			el: '#zhanwai',
			data: {
				centerDialogVisible: false,
				centerDialogVisible2: false,
				UserAndCardDialog: false,
				fixcount: '',
				fixgrop: '',
				fixgroptime: '',
				fixitemdata: [],
				formfix: {
					wid: '', //维修id
					wname: '', //客户姓名
					wjname: '', //接车人
					wcarid: '', //车牌号
					wphone: '', //客户号码
					wvipid: '', //会员卡号
					wstatic: '1', //维修状态
					wstatdate: '', //开始时间
					wenddate: '', //结束时间
					wsumprice:'',//维修价格
					tos:'',
					fixitem:'',
					fixcount:'1'
				},
				formfixinfo: [],
				fixitems: [],
				//表单数据
				form: {
					wcarid: '', //车牌号码
					wstatic: ''
				},
				fixdata: {},
				fixhistory: [{
					wid: '20200324001', //维修单号
					wstatdate: '2020-3-23', //接车时间
					tos: '快速洗车', //业务类型
					etime: '2020-3-27', //完工时间
					wname: '张三', //顾客姓名
					carid: '京E42S6', //车牌号码
					phone: '13875261423', //手机号码
					usercard: 'ZS2234', //会员卡号
					rtime: '2020-3-29', //结算时间
					price: '450.0' //消费金额
				}],
				fixStatusData: [],
				usersData: {
					cidk: '',
					cnamek: '',
					caddressk: '',
					csexk: '男',
					cphonek: '',
					cidnumberk: '',
					ctypek: '',
					ckahaok: ''
				},
				fixgoodsitem: [],
				fixgoods: []
			},
			mounted() {
				this.getServiceData(1);
				this.getServiceStatusData();
				this.getServiceItem();
				this.getServiceGoodsData();
				this.getServiceMaxWid();
			},
			methods: {
				openServiceDialog() {
					let _this = this;
					if(this.form.wcarid != '') {
						this.formfix.wcarid = this.form.wcarid;
						this.centerDialogVisible = true;
						//						this.getServiceData(1);
						//						if(this.fixdata.list.length == 0){
						//							this.$confirm('没有该车牌号及客户信息！是否添加？', '提示', {
						//							      confirmButtonText: '确定',
						//							      cancelButtonText: '取消',
						//							      type: 'warning',
						//							      center:true
						//							    }).then(() => {
						//							      _this.UserAndCardDialog = true;
						//							    }).catch(() => {
						//							    	_this.centerDialogVisible = true;
						//							    });
						//						}else{
						//							this.centerDialogVisible = true;
						//						}
					} else {
						this.$message({
							message: '请输入车牌号码再进行下单接车',
							center: true,
							type: 'error'
						});
					}

				},
				getServiceData(page) {
					let _this = this;
					$.getJSON("http://127.0.0.1:8080/yldaction/api/queryAllServicePage", {
							page: page,
							wcarid: _this.form.wcarid,
							wstatic: _this.form.wstatic
						},
						(msg) => {
							_this.fixdata = msg;
							console.info(msg+"12");
						});
				},
				getServiceStatusData() {
					let _this = this;
					$.getJSON("http://127.0.0.1:8080/yldaction/api/queryAllServiceStatus",
						(msg) => {
							_this.fixStatusData = msg;
							console.info(msg+"1");
						});
				},
				getServiceItem() {
					let _this = this;
					$.getJSON("http://127.0.0.1:8080/yldaction/api/queryAllGoodsItem",
						function(msg) {
							_this.fixgoodsitem = msg;
							console.info(msg+"33");
						});
				},
				getServiceGoodsData() {
					let _this = this;
					this.fixitem = '';
					$.getJSON("http://127.0.0.1:8080/yldaction/api/queryAllGoodsByType", {
							typeid: _this.formfix.tos
						},
						(msg) => {
							_this.fixgoods = msg;
							console.info(msg+"11");
						});
				},
				getServiceMaxWid(){
					let _this = this;
					$.getJSON("http://127.0.0.1:8080/yldaction/api/queryMaxWid",
					(msg) => {
						_this.formfix.wid = msg;
						console.info(msg);
					});
				},
				addServiceGoods(){
					let _this = this;
					$.each(_this.fixgoods, function(i,obj) {
						if(obj.gid == _this.formfix.fixitem){
							_this.fixitemdata.push({wid:_this.formfix.wid,sdname:obj.gname,sdprice:obj.gprice,sdnumber:_this.formfix.fixcount});
						}
					});
				},
				removeServiceGoods(i){
					let _this = this;
					_this.fixitemdata.splice(i,1);
				},
				addService(){
					let _this = this;
					let sumprice = 0;
					$.each(_this.fixitemdata, function(i,obj) {
						sumprice += parseInt(obj.sdprice) * parseInt(obj.sdnumber);
					});
					this.formfix.wsumprice = sumprice;
					$.ajax('http://127.0.0.1:8080/yldaction/api/insertService',{
					    type:'post',
					    dataType:'json',
					    contentType:'application/json',
					    data:JSON.stringify(_this.formfix),
					    success:function(msg){
					        if(msg == "ok"){
					        	$.ajax('http://127.0.0.1:8080/yldaction/api/insertServiceInfo',{
					        	    type:'post',
					        	    dataType:'json',
					    			contentType:'application/json',
					        	    data:JSON.stringify(_this.fixitemdata),
					        	    success:function(msg){
					        	        if(msg == "ok"){
					        	        	_this.$message({message:'添加成功！',center:true,type:'success'});
					        	        	_this.getServiceData(1);
					        	        	_this.centerDialogVisible = false;
					        	        }else{
					        	        	_this.$message({message:'添加失败！',center:true,type:'error'});
					        	        }
					        	    }
					        	});
					        }else{
					        	_this.$message({message:'添加失败！',center:true,type:'error'});
					        }
					    }
					});
				}
			}
		})
	</script>

</html>