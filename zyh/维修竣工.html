<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>维修竣工</title>
		<link rel="stylesheet" type="text/css" href="../css/index.css" />
		<link rel="stylesheet" href="../css/bootstrap.min.css" />

	</head>

	<body style="background-color: #e6e6e6;">

		<div id="juegong" style=" width: 1290px; margin: 0px auto;margin-top: 2ex; background-color: white;height: 650px;padding: 10px;">
			<h3 style="margin: 0px auto; width: 300px;text-align: center;padding-top: 1ex;">维修数据

			</h3>

			<template>
				<el-tabs style="margin-top: 0px;width: 1200px;margin:  0px auto;" v-model="activeName" @tab-click="handleClick">
					<el-tab-pane label="未竣工" name="first">

						<div style="text-align: center; margin: 2ex;">
							<span style="margin-right: 3ex;">车牌号查看：
  <el-input
  	size="mini"
  	style="width: 150px;"
  placeholder="请输入内容"
  v-model="chepaiLIke"
  clearable>
</el-input></span>
							<span>日期查看：
    <el-date-picker
    	size="mini"
      v-model="dates"
      type="datetimerange"
      range-separator="至"
      start-placeholder="开始日期"
      end-placeholder="结束日期"
      align="right">
    </el-date-picker></span>
							<el-button type="primary" size="mini" @click="queryCk">查看</el-button>
						</div>

						<template>

							<el-table :data="tableData.list" style="margin: 0px auto;">
								<el-table-column prop="wcarid" align="center" label="维修车牌号">

								</el-table-column>
									<el-table-column prop="wtype" align="center" label="维修类型" >

								</el-table-column>

								<el-table-column align="center" label="开始维修日期" width="180" sortable>
									<template slot-scope="scope">
										<i class="el-icon-time"></i>
										<span style="margin-left: 10px">{{ scope.row.wstatdate }}</span>
									</template>
								</el-table-column>

								<el-table-column align="center" label="结束维修日期"  width="180" sortable>
									<template slot-scope="scope">
										<i class="el-icon-time"></i>
										<span style="margin-left: 10px">{{ scope.row.wenddate }}</span>
									</template>
								</el-table-column>
								<el-table-column align="center" label="维修金额" prop="summoney" sortable>
									<template slot-scope="scope">
										￥{{ scope.row.wsumprice }}
									</template>
								</el-table-column>
								
									<el-table-column align="center" label="维修状态"  >
									<template slot-scope="scope">
									<span style="color: #E6A23C;" >{{scope.row.statucname}}</span>
									</template>
								</el-table-column>
								
								<el-table-column label="操作" width="280" align="center">
									<template slot-scope="scope">

										<el-button type="primary" size="mini" @click="handleEdit(scope.$index, scope.row)">竣工检验</el-button>
										<el-button type="success" size="mini" type="danger" @click="handleDelete(scope.$index, scope.row.list)">维修详细</el-button>
									</template>
								</el-table-column>
							</el-table>
						</template>
						<div class="block" style="text-align: center;margin-top: 3ex;">
							<el-pagination @size-change="handleSizeChange" 
								@current-change="handleCurrentChange" 
								:current-page="currentPage4" 
								:page-sizes="[6,3,1]" 
								:page-size="tableData.pageSize" 
								layout="total, sizes, prev, pager, next, jumper" 
								:total="tableData.total">
							</el-pagination>
						</div>

					</el-tab-pane>
					<el-tab-pane label="已竣工" name="second">

						<div style="text-align: center; margin: 2ex;">
							<span style="margin-right: 3ex;">车牌号查看：
  <el-input
  	size="mini"
  	style="width: 150px;"
  placeholder="请输入内容"
  v-model="chepaiLIke2"
  clearable>
</el-input></span>
							<span>日期查看：
    <el-date-picker
    	size="mini"
      v-model="dates2"
      type="datetimerange"
      range-separator="至"
      start-placeholder="开始日期"
      end-placeholder="结束日期"
      align="right">
    </el-date-picker></span>
							<el-button type="primary" size="mini" @click="queryCk2">查看</el-button>
						</div>

						<template>

							<el-table :data="tableData2.list" style="margin: 0px auto;">
								<el-table-column prop="wcarid" align="center" label="维修车牌号">

								</el-table-column>
										<el-table-column prop="wtype" align="center" label="维修类型" >

								</el-table-column>

								<el-table-column align="center" label="开始维修日期"  width="180" sortable>
									<template slot-scope="scope">
										<i class="el-icon-time"></i>
										<span style="margin-left: 10px">{{ scope.row.wstatdate }}</span>
									</template>
								</el-table-column>

								<el-table-column align="center" label="结束维修日期"  width="180" sortable>
									<template slot-scope="scope">
										<i class="el-icon-time"></i>
										<span style="margin-left: 10px">{{ scope.row.wenddate }}</span>
									</template>
								</el-table-column>
								<el-table-column align="center" label="维修总金额" sortable>
									<template slot-scope="scope">
										￥{{ scope.row.wsumprice }}
									</template>
								</el-table-column>
										<el-table-column align="center" label="维修状态"  >
									<template slot-scope="scope">
									<span style="color: #E6A23C;" >{{scope.row.statucname}}</span>
									</template>
								</el-table-column>
								<el-table-column label="操作" width="280" align="center">
									<template slot-scope="scope">
										<el-button type="success" size="mini" type="danger" @click="handleDelete(scope.$index, scope.row.list)">维修详细</el-button>
									</template>
								</el-table-column>
							</el-table>
						</template>
						<div class="block" style="text-align: center;margin-top: 3ex;">
							<el-pagination @size-change="handleSizeChange2"
								 @current-change="handleCurrentChange2" 
								 :current-page="currentPage5"
								  :page-sizes="[6,3,1]" :page-size="tableData2.pageSize" 
								  layout="total, sizes, prev, pager, next, jumper" 
								  :total="tableData2.total">
							</el-pagination>
						</div>

					</el-tab-pane>

				</el-tabs>

				<el-dialog title="维修详细信息" align="center" :visible.sync="dialogVisible" width="800px" :before-close="handleClose">
					<template>
						<el-table :data="xiangXiData" style="width: 100%;margin: 0px auto;margin-top: -2ex;">
							<el-table-column label="编号" align="center" width="180">
								<template slot-scope="scope">
									{{scope.$index+1}}
								</template>
							</el-table-column>
							<el-table-column prop="sdname" align="center" label="维修项目名称">
							</el-table-column>
							<el-table-column align="center" label="维修价格">
								<template slot-scope="scope">
									<label style="">￥{{scope.row.sdprice}}</label>
								</template>
							</el-table-column>
							<el-table-column align="center" label="件数">
								<template slot-scope="scope">
									<label style="">{{scope.row.sdnumber}}件</label>
								</template>
							</el-table-column>

						</el-table>
						<i style="float: left;margin-left: 5ex;margin-top: 3ex;">总金额：<span style="color: red;">￥{{moneySum}}</span></i>
					</template>

					<span slot="footer" class="dialog-footer">
    <el-button @click="dialogVisible = false">取 消</el-button>
    <el-button type="primary" @click="dialogVisible = false">确 定</el-button>
  </span>
				</el-dialog>

				<el-dialog style="text-align: center;" title="提示竣工" align="center" :visible.sync="dialogVisible2" width="400px" :before-close="handleClose">
					<template>
						提醒：一但确定竣工就不得修改撤销<br/>
						<div style="margin-top: 3ex;text-align: center;">
							<el-radio v-model="radio2" @change="radioFanGong" label="1">完工</el-radio>
							<el-radio v-model="radio2" @change="radioFanGong" label="2">已方返工</el-radio>
							<el-radio v-model="radio2" @change="radioFanGong" label="3">客户返工</el-radio>
							<p v-if="fangoufeiwuxianshi">
								<template>
									选择维修项目：
									<el-select v-model="value" @change="selectChange" filterable placeholder="请选择">
										<el-option v-for="(item,i) in weixiu" :key="item.value" :label="item.label" :value="i">
										</el-option>
									</el-select>
								</template>
								<table v-if="weixiuTable.length!=0" style="width: 350px;border:1px solid;text-align: center;margin: 0px auto;">
									<tr>
										<td>编号</td>
										<td>维修名称</td>
										<td>价格</td>
										<td>操作</td>
									</tr>
									<tr v-for="(temp,i) in weixiuTable" style="margin: 5px;">
										<td>{{i+1}}</td>
										<td>{{temp.sdname}}</td>
										<td>{{temp.sdprice}}</td>
										<td>
											<a href="javascript:void(0)" @click="removeweixiu(i)" class="el-icon-delete"></a>
										</td>
									</tr>

								</table>

							</p>
							<span slot="footer" class="dialog-footer" style="margin-top: 3ex;display: inline-block;">
    <el-button type="primary" style="margin-right: 3ex;" @click="dialogVisible2Api">确 定</el-button>
    <el-button @click="dialogVisible2 = false">取 消</el-button>
  </span>
						</div>
					</template>

				</el-dialog>
			</template>

		</div>

	</body>

	<script type="text/javascript" src="../js/jquery-1.12.4.js"></script>
	<script src="../js/bootstrap.min.js"></script>
	<script type="text/javascript" src="../js/vue.js"></script>
	<script type="text/javascript" src="../js/index.js"></script>
	<script type="text/javascript" src="../js/jq_ajax_config.js"></script>
	<script>
		var zhnanei = new Vue({
			el: "#juegong",
			data: {
				weixiuTable: [],
				value: "",
				weixiu: [{
						value: '2',
						label: '洗车',
						money: 123
					},
					{
						value: '1',
						label: '换发动机',
						money: 1000
					}
				],
				dates:null,
				chepaiLIke: "",
				dates2:null,
				chepaiLIke2: "",
				activeName: 'first',
				fangoufeiwuxianshi: false,
				fangongfeiyong: '',
				moneySum: 0,
				xiangXiData: [],
				dialogVisible: false,
				dialogVisible_2: false,
				dialogVisible2: false,
				radio: '1',
				radio2: "1",
				currentPage4: 1,
				currentPage5: 1,
				tableData: [],
				tableData2:[]
			},
			methods: {
				/*刪除返工维修的项目*/
				removeweixiu(index) {
					this.weixiuTable.splice(index, 1);
				},
				selectChange() {
					let bool = false;
					this.weixiuTable.forEach(row => {
						console.log(`${this.value}`)
						console.log(`清单${row.name}|添加${this.weixiu[this.value].label}`)
						if(row.name == this.weixiu[this.value].label) {
							return bool = true;
						}

					});
					if(bool) {
						return
					}
					this.weixiuTable.splice(0, 0, {
						name: this.weixiu[this.value].label,
						money: this.weixiu[this.value].money
					})
				},
				handleClick(tab, event) {
					console.log(tab, event);
				},
				/*是否返工确定*/
				dialogVisible2Api() {
					let _this = this;
					if(this.fangoufeiwuxianshi && this.fangongfeiyong == '') {
						this.$message({
							showClose: true,
							message: '请输入返工费用！',
							type: 'error'
						});

						return
					}

					_this.$confirm('操作执行不能撤销, 是否继续?', '提示', {
						confirmButtonText: '确定',
						cancelButtonText: '取消',
						type: 'warning'
					}).then(() => {
						_this.$message({
							type: 'success',
							message: '操作成功!'
						});
						_this.dialogVisible2 = false;
						_this.fangoufeiwuxianshi = false;
						_this.fangongfeiyong = '';
						_this.radio2 = '1';
					}).catch(() => {
						_this.$message({
							type: 'info',
							message: '已取消操作'
						});
					});

				},
				/*查看*/
				queryCk(){
					this.page(1,this.tableData.pageSize,1,2);
				},
				queryCk2(){
					this.page(1,this.tableData2.pageSize,3,0);
				},
				/*返工选择*/
				radioFanGong(val) {
					if(val == 3) {
						this.fangoufeiwuxianshi = true;
					} else {
						this.fangoufeiwuxianshi = false;
					}
				},
				/*分页*/
				page(n,s,statuc1,statuc2){
					let _this=this;
					let wcarid;
					if(statuc2==0){
						wcarid=this.chepaiLIke2==""?null:this.chepaiLIke2;
					}else{
						wcarid=this.chepaiLIke==""?null:this.chepaiLIke;
					}
					
					statdate=this.dates;
					enddate=this.dates;
					if(statuc2==0 && this.dates2!=null){
						statdate=this.dates2[0];
						enddate=this.dates2[1];
					}else if(statuc2!=0 && this.dates!=null){
						statdate=this.dates[0];
						enddate=this.dates[1];
					
					}
					$.getJSON(`http://127.0.0.1:8080/zyhServiceAction/api/queryStatucBy1Or2/${wcarid}/${statdate}/${enddate}/${n}/${s}/${statuc1}/${statuc2}`, function(data) {
					
						if(statuc2==0){
							_this.tableData2=data;
						_this.currentPage5=data.pageNum;
						}else{
								_this.tableData=data;
						_this.currentPage4=data.pageNum;
						}
						
					});
				},
				handleSizeChange(val) {
					this.currentPage4=1;
					this.page(1,val,1,2);
					console.log(`每页 ${val} 条`);
				},
				handleCurrentChange(val) {
					this.page(val,this.tableData.pageSize,1,2);
					console.log(`当前页: ${val}`);
				},
				handleSizeChange2(val) {
					this.currentPage5=1;
					this.page(1,val,3,0);
					console.log(`每页 ${val} 条`);
				},
				handleCurrentChange2(val) {
					this.page(val,this.tableData2.pageSize,3,0);
					console.log(`当前页: ${val}`);
				},
				/*竣工操作*/
				handleEdit(index, row) {
					this.dialogVisible2 = true;
					console.log(index, row);
				},
				/*维修详细*/
				handleDelete(index, row) {
					let _this = this;
					let money = 0;
					this.dialogVisible = true;
					this.xiangXiData =row;
					$.each(this.xiangXiData, function(i, obj) {
						money += obj.sdprice;
					})
					this.moneySum = money;
					console.log(index, row);
				},
				/*详细信息关闭*/
				handleClose(done) {
					this.$confirm('确认关闭？')
						.then(_ => {
							done();
						})
						.catch(_ => {});
				}

			},
			mounted() {
				this.page(1,6,1,2);
				this.page(1,6,3,0);
			}
		})
	</script>

</html>